# Atelier PowerShell & Active Directory

## Contexte professionnel

Vous √™tes administrateur syst√®me chez **TechSecure**, une entreprise de 200 employ√©s. L'entreprise utilise Active Directory pour g√©rer les comptes utilisateurs, les groupes et l'organisation de son infrastructure.

Actuellement, toutes les op√©rations AD se font manuellement via l'interface graphique (ADUC - Active Directory Users and Computers), ce qui prend beaucoup de temps et g√©n√®re des erreurs. Votre direction souhaite **automatiser** la gestion de l'Active Directory avec PowerShell.

Votre mission : ma√Ætriser PowerShell pour g√©rer efficacement l'Active Directory et cr√©er des outils d'automatisation pour les t√¢ches courantes.

## Objectifs de l'atelier

√Ä l'issue de cet atelier, vous serez capable de :
- Installer et utiliser le module ActiveDirectory
- G√©rer les utilisateurs AD en PowerShell
- G√©rer les groupes et leurs membres
- Organiser l'annuaire avec des Unit√©s Organisationnelles
- Importer des utilisateurs en masse depuis CSV
- Cr√©er des scripts d'automatisation pour l'onboarding/offboarding
- G√©n√©rer des rapports sur l'√©tat de l'AD

---

## Partie 1 : D√©couverte du module ActiveDirectory

### Objectif
Installer et d√©couvrir le module PowerShell pour Active Directory.

### Travail √† r√©aliser

**1.1 - Installation du module (si n√©cessaire)**

V√©rifiez si le module ActiveDirectory est disponible sur votre syst√®me. Si ce n'est pas le cas, installez-le.

**1.2 - Exploration du module**

- Listez toutes les cmdlets disponibles dans le module ActiveDirectory
- Combien de cmdlets sont disponibles ?
- Listez uniquement les cmdlets qui commencent par `Get-ADUser`
- Affichez l'aide compl√®te de la cmdlet `Get-ADUser`

**1.3 - Connexion √† l'Active Directory**

- Testez votre connexion √† l'AD en r√©cup√©rant des informations sur le domaine
- Affichez le nom du domaine, le niveau fonctionnel et les contr√¥leurs de domaine

**1.4 - Premier utilisateur**

- R√©cup√©rez les informations de votre propre compte utilisateur AD
- Affichez toutes ses propri√©t√©s
- Affichez uniquement son nom, son email et son titre

---

## Partie 2 : Gestion des utilisateurs

### Objectif
Ma√Ætriser les op√©rations CRUD (Create, Read, Update, Delete) sur les utilisateurs AD.

### Travail √† r√©aliser

**2.1 - Cr√©er des utilisateurs**

Cr√©ez les utilisateurs suivants dans l'OU de votre choix :

| Pr√©nom | Nom | Login | Email | Titre |
|--------|-----|-------|-------|-------|
| Alice | Martin | amartin | alice.martin@techsecure.fr | D√©veloppeuse |
| Bob | Dubois | bdubois | bob.dubois@techsecure.fr | Administrateur Syst√®me |
| Claire | Bernard | cbernard | claire.bernard@techsecure.fr | Chef de Projet |

Pour chaque utilisateur :
- D√©finir un mot de passe initial (ex: "P@ssw0rd123!")
- Le compte doit √™tre activ√©
- Le mot de passe doit √™tre chang√© √† la premi√®re connexion

**2.2 - Rechercher des utilisateurs**

- Listez tous les utilisateurs de votre domaine
- Trouvez l'utilisateur dont le login est "amartin"
- Trouvez tous les utilisateurs dont le nom commence par "B"
- Trouvez tous les utilisateurs qui ont "Administrateur" dans leur titre
- Comptez le nombre total d'utilisateurs dans votre domaine

**2.3 - Modifier des utilisateurs**

Pour l'utilisateur "amartin" :
- Changez son num√©ro de t√©l√©phone (ajoutez: "01 23 45 67 89")
- Ajoutez une description ("Membre de l'√©quipe d√©veloppement")
- Changez son titre en "D√©veloppeuse Senior"

**2.4 - D√©sactiver et supprimer**

- D√©sactivez le compte "bdubois"
- V√©rifiez qu'il est bien d√©sactiv√©
- Supprimez le compte "cbernard" (attention : demander confirmation avant)

---

## Partie 3 : Gestion des groupes

### Objectif
Cr√©er des groupes de s√©curit√© et g√©rer les appartenances.

### Travail √† r√©aliser

**3.1 - Cr√©er des groupes**

Cr√©ez les groupes de s√©curit√© suivants :

| Nom du groupe | Type | Port√©e | Description |
|---------------|------|--------|-------------|
| GRP_Developpeurs | Security | Global | √âquipe de d√©veloppement |
| GRP_Admins_Systeme | Security | Global | Administrateurs syst√®me |
| GRP_Chefs_Projet | Security | Global | Chefs de projet |
| GRP_IT | Security | Global | Ensemble du d√©partement IT |

**3.2 - Ajouter des membres**

- Ajoutez "amartin" dans le groupe "GRP_Developpeurs"
- Ajoutez "bdubois" dans le groupe "GRP_Admins_Systeme"
- Cr√©ez 2 nouveaux utilisateurs et ajoutez-les dans "GRP_Developpeurs"
- Ajoutez tous les membres des trois premiers groupes dans "GRP_IT"

**3.3 - Lister les appartenances**

- Affichez tous les membres du groupe "GRP_IT"
- Affichez tous les groupes dont "amartin" est membre
- Comptez combien de membres a chaque groupe

**3.4 - Retirer des membres**

- Retirez "amartin" du groupe "GRP_IT"
- V√©rifiez qu'elle n'en est plus membre

**3.5 - Groupes imbriqu√©s**

- Cr√©ez un groupe "GRP_Tous_Utilisateurs"
- Ajoutez-y les groupes "GRP_IT" (pas les membres individuels, mais le groupe lui-m√™me)
- Listez les membres (directs et r√©cursifs) de "GRP_Tous_Utilisateurs"

---

## Partie 4 : Organisation avec les Unit√©s Organisationnelles (OU)

### Objectif
Structurer l'annuaire Active Directory avec des OU.

### Travail √† r√©aliser

**4.1 - Cr√©er une structure d'OU**

Cr√©ez la structure suivante dans votre domaine :

```
TechSecure/
‚îú‚îÄ‚îÄ Utilisateurs/
‚îÇ   ‚îú‚îÄ‚îÄ Informatique/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Developpement/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Infrastructure/
‚îÇ   ‚îú‚îÄ‚îÄ RH/
‚îÇ   ‚îî‚îÄ‚îÄ Commercial/
‚îú‚îÄ‚îÄ Groupes/
‚îî‚îÄ‚îÄ Ordinateurs/
```

**4.2 - D√©placer des objets**

- D√©placez l'utilisateur "amartin" dans l'OU "TechSecure/Utilisateurs/Informatique/Developpement"
- D√©placez tous vos groupes cr√©√©s pr√©c√©demment dans l'OU "TechSecure/Groupes"
- Listez tous les utilisateurs pr√©sents dans l'OU "Informatique" (incluant les sous-OU)

**4.3 - Recherche par OU**

- Comptez le nombre d'utilisateurs dans l'OU "Informatique" uniquement (sans les sous-OU)
- Comptez le nombre d'utilisateurs dans l'OU "Informatique" en incluant tous les sous-niveaux

---

## Partie 5 : Import en masse depuis CSV

### Objectif
Automatiser la cr√©ation d'utilisateurs en important les donn√©es depuis un fichier CSV.

### Travail √† r√©aliser

**5.1 - Pr√©parer le fichier CSV**

Cr√©ez un fichier `nouveaux_employes.csv` avec la structure suivante :

```csv
Prenom,Nom,Login,Email,Titre,Departement,OU
David,Petit,dpetit,david.petit@techsecure.fr,D√©veloppeur,Informatique,OU=Developpement,OU=Informatique,OU=Utilisateurs,OU=TechSecure
Emma,Roux,eroux,emma.roux@techsecure.fr,Administratrice R√©seau,Informatique,OU=Infrastructure,OU=Informatique,OU=Utilisateurs,OU=TechSecure
Fran√ßois,Moreau,fmoreau,francois.moreau@techsecure.fr,Recruteur,RH,OU=RH,OU=Utilisateurs,OU=TechSecure
```

Ajoutez au moins 10 autres lignes avec des employ√©s fictifs.

**5.2 - Script d'import basique**

Cr√©ez un script `Import-ADUsersFromCSV.ps1` qui :
- Lit le fichier CSV
- Pour chaque ligne, cr√©e un utilisateur AD avec toutes les propri√©t√©s
- D√©finit un mot de passe par d√©faut
- Active le compte
- Affiche un message pour chaque utilisateur cr√©√©

**5.3 - Am√©liorer le script avec gestion d'erreurs**

Modifiez votre script pour :
- V√©rifier que le CSV existe avant de commencer
- Utiliser `try-catch` pour g√©rer les erreurs de cr√©ation
- V√©rifier si l'utilisateur existe d√©j√† avant de le cr√©er
- Logger les succ√®s et les erreurs dans un fichier `import.log`
- Afficher un r√©sum√© √† la fin (X cr√©√©s, Y erreurs)

**5.4 - Ajouter les groupes lors de l'import**

Ajoutez une colonne "Groupes" dans votre CSV (plusieurs groupes s√©par√©s par des points-virgules).

Modifiez votre script pour ajouter automatiquement les utilisateurs dans les groupes sp√©cifi√©s.

---

## Partie 6 : Scripts d'automatisation

### Objectif
Cr√©er des scripts r√©utilisables pour les t√¢ches courantes.

### Travail √† r√©aliser

**6.1 - Script d'onboarding**

Cr√©ez un script `New-Employee.ps1` qui prend des param√®tres et effectue un onboarding complet :

Le script doit :
- Accepter en param√®tres : Pr√©nom, Nom, Titre, D√©partement, Manager
- G√©n√©rer automatiquement le login (premi√®re lettre pr√©nom + nom)
- G√©n√©rer l'email (@techsecure.fr)
- Cr√©er l'utilisateur dans la bonne OU selon le d√©partement
- G√©n√©rer un mot de passe al√©atoire s√©curis√©
- Ajouter l'utilisateur dans les groupes appropri√©s selon son d√©partement
- Envoyer un email de bienvenue (simulation avec Write-Host)
- Logger toutes les op√©rations

**6.2 - Script d'offboarding**

Cr√©ez un script `Remove-Employee.ps1` qui :
- Prend en param√®tre le login de l'utilisateur
- D√©sactive le compte
- Retire l'utilisateur de tous ses groupes
- D√©place l'utilisateur vers une OU "Comptes D√©sactiv√©s"
- R√©initialise son mot de passe
- Ajoute une note dans la description avec la date de d√©sactivation
- Logger toutes les op√©rations
- Demande confirmation avant chaque action critique

**6.3 - Script de modification de mot de passe**

Cr√©ez un script `Reset-EmployeePassword.ps1` qui :
- Prend en param√®tre le login
- G√©n√®re un nouveau mot de passe al√©atoire s√©curis√©
- Change le mot de passe de l'utilisateur
- Force le changement √† la prochaine connexion
- Affiche le nouveau mot de passe (pour transmission s√©curis√©e)
- D√©verrouille le compte si n√©cessaire

---

## Partie 7 : Rapports et audits

### Objectif
Cr√©er des scripts de reporting pour auditer l'Active Directory.

### Travail √† r√©aliser

**7.1 - Rapport des utilisateurs inactifs**

Cr√©ez un script `Get-InactiveUsers.ps1` qui :
- Liste tous les utilisateurs n'ayant pas chang√© leur mot de passe depuis plus de 90 jours
- Affiche : Login, Nom, Derni√®re modification du mot de passe, Jours depuis modification
- Trie par nombre de jours d√©croissant
- Exporte le r√©sultat en CSV

**7.2 - Rapport des comptes d√©sactiv√©s**

Cr√©ez un script qui :
- Liste tous les comptes utilisateurs d√©sactiv√©s
- Affiche : Login, Nom, OU, Date de d√©sactivation (si dans description)
- Compte le nombre total
- Exporte en CSV

**7.3 - Rapport des groupes et membres**

Cr√©ez un script qui :
- Liste tous les groupes de s√©curit√©
- Pour chaque groupe, affiche le nombre de membres
- Identifie les groupes vides
- Exporte un rapport d√©taill√© en HTML avec :
  - Nom du groupe
  - Description
  - Nombre de membres
  - Liste des membres

**7.4 - Rapport d'audit complet**

Cr√©ez un script `Get-ADHealthReport.ps1` qui g√©n√®re un rapport HTML complet avec :
- Nombre total d'utilisateurs (actifs/d√©sactifs)
- Nombre total de groupes
- Nombre d'OU
- Top 10 des groupes avec le plus de membres
- Liste des utilisateurs dont le mot de passe n'expire jamais
- Liste des utilisateurs avec des mots de passe expir√©s
- Statistiques par d√©partement

---

## Partie 8 : Projet final - Outil de gestion AD complet

### Objectif
Cr√©er un outil interactif complet de gestion Active Directory.

### Travail √† r√©aliser

**8.1 - Menu principal**

Cr√©ez un script `AD-Manager.ps1` avec un menu interactif proposant :

```
=== GESTIONNAIRE ACTIVE DIRECTORY ===

UTILISATEURS
1. Cr√©er un utilisateur
2. Rechercher un utilisateur
3. Modifier un utilisateur
4. D√©sactiver un utilisateur
5. Supprimer un utilisateur

GROUPES
6. Cr√©er un groupe
7. Ajouter un membre √† un groupe
8. Retirer un membre d'un groupe
9. Lister les membres d'un groupe

IMPORT/EXPORT
10. Importer des utilisateurs depuis CSV
11. Exporter tous les utilisateurs en CSV

RAPPORTS
12. Rapport des utilisateurs inactifs
13. Rapport des groupes
14. Audit complet

AUTRES
15. R√©initialiser un mot de passe
16. Quitter
```

**8.2 - Fonctionnalit√©s avanc√©es**

Ajoutez √† votre outil :
- Validation des entr√©es utilisateur
- Gestion d'erreurs robuste avec try-catch
- Messages color√©s (succ√®s en vert, erreurs en rouge, avertissements en jaune)
- Confirmation avant les actions destructives
- Logging de toutes les op√©rations dans un fichier
- Possibilit√© de revenir au menu apr√®s chaque action

**8.3 - Tests**

Testez votre outil en effectuant :
- La cr√©ation de 5 nouveaux utilisateurs
- L'import d'un CSV de 10 utilisateurs
- La cr√©ation de 3 groupes et l'ajout de membres
- La g√©n√©ration d'un rapport complet
- La d√©sactivation d'un utilisateur

---

## Partie 9 : Synth√®se et bonnes pratiques

### Objectif
R√©fl√©chir aux apprentissages et aux bonnes pratiques.

### Travail √† r√©aliser

**9.1 - Documentation**

Cr√©ez un fichier `README.md` qui documente :
- Tous les scripts que vous avez cr√©√©s
- Comment les utiliser
- Les pr√©requis n√©cessaires
- Des exemples d'utilisation

**9.2 - R√©flexion**

Cr√©ez un fichier `RETOUR_EXPERIENCE.txt` r√©pondant aux questions :

1. Quelles sont les 3 cmdlets AD que vous utilisez le plus souvent ?
2. Quelle est la diff√©rence entre `-Filter` et `-LDAPFilter` ?
3. Pourquoi est-il important de toujours utiliser `try-catch` avec les op√©rations AD ?
4. Comment feriez-vous pour g√©rer l'AD de plusieurs domaines diff√©rents ?
5. Quels sont les risques de s√©curit√© √† consid√©rer lors de l'automatisation AD ?
6. Comment pourriez-vous am√©liorer vos scripts pour une utilisation en production ?

**9.3 - Am√©liorations futures**

Listez 5 fonctionnalit√©s que vous pourriez ajouter √† votre outil de gestion AD pour le rendre encore plus utile en production.

---

## Ressources utiles

**Documentation Microsoft** :
- Module ActiveDirectory : https://docs.microsoft.com/powershell/module/activedirectory/
- Gestion des utilisateurs AD : https://docs.microsoft.com/windows-server/identity/ad-ds/

**Cmdlets essentielles** :
- Utilisateurs : `Get-ADUser`, `New-ADUser`, `Set-ADUser`, `Remove-ADUser`
- Groupes : `Get-ADGroup`, `New-ADGroup`, `Add-ADGroupMember`, `Get-ADGroupMember`
- OU : `Get-ADOrganizationalUnit`, `New-ADOrganizationalUnit`, `Move-ADObject`
- Domaine : `Get-ADDomain`, `Get-ADForest`, `Get-ADDomainController`

---

## Conseils pour r√©ussir üí°

**Organisation** :
- Cr√©ez un dossier `C:\Scripts\AD` pour tous vos scripts
- Nommez vos scripts de mani√®re explicite (verbe-nom)
- Commentez votre code au fur et √† mesure

**S√©curit√©** :
- Ne stockez jamais de mots de passe en clair dans vos scripts
- Testez toujours dans un environnement de test avant la production
- Utilisez `-WhatIf` pour simuler les actions destructives
- Demandez confirmation pour les suppressions

**Debugging** :
- Utilisez `Write-Host` ou `Write-Verbose` pour tracer l'ex√©cution
- Testez vos filtres avec `Get-ADUser` avant de cr√©er/modifier
- V√©rifiez les propri√©t√©s disponibles avec `Get-ADUser | Get-Member`

**Performance** :
- Utilisez `-Filter` plut√¥t que `Where-Object` pour filtrer c√¥t√© serveur
- Limitez les propri√©t√©s r√©cup√©r√©es avec `-Properties` uniquement si n√©cessaire
- Pour de gros volumes, utilisez `-ResultSetSize` pour limiter les r√©sultats

---